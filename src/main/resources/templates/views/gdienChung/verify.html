<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{/views/gdienChung/templateChung.html::view(~{::main}, ~{::title})}">

    <head>
        <meta charset="UTF-8">
        <title>X√°c minh email</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>

    <body>
        <main class="verify">
            <section class="container mt-5"
                style="margin-top: 35px; margin-bottom: 55px;">
                <div class="row justify-content-center">
                    <div class="col-md-6 col-lg-5">
                        <div class="verify-card">
                            <div class="body p-4">

                                <!-- <h4 class="card-title text-center text-primary mb-4">
                                ‚úâÔ∏è Nh·∫≠p m√£ x√°c minh email
                            </h4> -->

                                <h4
                                    class="card-title text-center text-primary mb-4">
                                    <span th:if="${type == 'register'}">‚úâÔ∏è Nh·∫≠p
                                        m√£ x√°c minh ƒëƒÉng k√Ω</span>
                                    <span th:if="${type == 'update-email'}">üìß
                                        X√°c minh thay ƒë·ªïi email</span>
                                    <span th:if="${type == 'forgot'}">üîê Nh·∫≠p m√£
                                        x√°c minh qu√™n m·∫≠t kh·∫©u</span>
                                </h4>

                                <!-- <p class="text-muted text-center">
                                M√£ ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ƒë·ªãa ch·ªâ email b·∫°n ƒë√£ ƒëƒÉng k√Ω
                            </p> -->

                                <p class="text-muted text-center">
                                    <span th:if="${type == 'register'}">M√£ ƒë√£
                                        ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email b·∫°n d√πng ƒë·ªÉ ƒëƒÉng
                                        k√Ω.</span>
                                    <span th:if="${type == 'update-email'}">M√£
                                        ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email m·ªõi ƒë·ªÉ x√°c minh
                                        thay ƒë·ªïi.</span>
                                    <span th:if="${type == 'forgot'}">M√£ ƒë√£ ƒë∆∞·ª£c
                                        g·ª≠i ƒë·∫øn email ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t
                                        kh·∫©u.</span>
                                </p>

                                <form
                                    th:action="@{${type == 'forgot' ? '/lay-lai-mat-khau/verify' : '/auth/verify'}}"
                                    method="post">
                                    <div class="mb-3">
                                        <label for="code" class="form-label">M√£
                                            x√°c minh:</label>
                                        <input type="text" name="code"
                                            class="form-control" required
                                            placeholder="Nh·∫≠p m√£ 6 ch·ªØ s·ªë" />
                                    </div>

                                    <!-- Truy·ªÅn email n·∫øu l√† forgot -->
                                    <input type="hidden" name="email"
                                        th:if="${type == 'forgot'}"
                                        th:value="${session.resetEmail}" />
                                    <input type="hidden" name="type"
                                        th:value="${type}" />

                                    <div th:if="${error}"
                                        class="alert alert-danger text-center"
                                        th:text="${error}"></div>

                                    <button id="btn-verify" type="submit"
                                        class="btn btn-primary w-100 mt-3"> <i
                                            class="fas fa-check-circle me-2"></i>X√°c
                                        minh</button>

                                </form>
                                <div class="text-center mt-3">
                                    <small class="text-muted"
                                        id="countdownText">
                                        Ch∆∞a nh·∫≠n ƒë∆∞·ª£c m√£? Vui l√≤ng ki·ªÉm tra l·∫°i
                                        email ho·∫∑c g·ª≠i l·∫°i sau
                                        <span id="countdown">120</span> gi√¢y.
                                    </small>
                                    <form
                                        th:action="@{${type == 'forgot' ? '/lay-lai-mat-khau' : (type == 'register' ? '/auth/resend-register' : '/auth/resend-update-email')}}"
                                        method="post" id="resendForm"
                                        style="display: none;">
                                        <input type="hidden" name="email"
                                            th:value="${type == 'forgot' ? session.resetEmail : session.pendingEmail}" />
                                        <input type="hidden" name="type"
                                            th:value="${type}" />
                                        <button type="submit"
                                            class="btn btn-link p-0 mt-2">üîÑ G·ª≠i
                                            l·∫°i m√£ x√°c th·ª±c</button>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <div id="js-vars" data-error="[[${error}]]"
                data-reset="[[${resetVerify}]]" style="display: none;"></div>

            <script>
            const countdownSpan = document.getElementById("countdown");
            const countdownText = document.getElementById("countdownText");
            const resendForm = document.getElementById("resendForm");
            const verifyButton = document.getElementById("btn-verify");

            const TOTAL_TIME = 120;
            const STORAGE_KEY = "verifyStartTime";

            const jsVars = document.getElementById("js-vars");
            const errorMessage = jsVars && jsVars.dataset ? jsVars.dataset.error : "";
            const isReset = jsVars && jsVars.dataset ? jsVars.dataset.reset === "true" : false;


            if (!errorMessage.includes("h·∫øt h·∫°n")) {
                if (isReset || !sessionStorage.getItem(STORAGE_KEY)) {
                    sessionStorage.setItem(STORAGE_KEY, Date.now());
                }

                function updateCountdown() {
                    const startTime = parseInt(sessionStorage.getItem(STORAGE_KEY));
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    const remaining = TOTAL_TIME - elapsed;

                    if (remaining > 0) {
                        countdownSpan.textContent = remaining;
                        verifyButton.style.display = "block";
                    } else {
                        clearInterval(timer);
                        countdownText.style.display = "none";
                        resendForm.style.display = "block";
                        verifyButton.style.display = "none";
                        sessionStorage.removeItem(STORAGE_KEY);
                    }
                }

                updateCountdown();
                const timer = setInterval(updateCountdown, 1000);
            } else {
                countdownText.style.display = "none";
                resendForm.style.display = "block";
                verifyButton.style.display = "none";
                sessionStorage.removeItem(STORAGE_KEY);
            }

            resendForm.addEventListener("submit", () => {
                sessionStorage.setItem(STORAGE_KEY, Date.now()); // ƒë·∫∑t l·∫°i th·ªùi gian
                verifyButton.style.display = "block"; // hi·ªán l·∫°i n√∫t x√°c minh
            });
        </script>
        </main>
    </body>

</html>