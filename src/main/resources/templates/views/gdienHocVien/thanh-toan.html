<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
    th:replace="~{/views/gdienChung/templateChung.html::view(~{::main}, ~{::title})}">

    <head>
        <meta charset="UTF-8">
        <title>Xác nhận thanh toán</title>
        <style>
        #qrModal .modal-content {
            background-color: white;
            color: black;
            border-radius: 12px;
            max-width: 300px;
            margin: auto;
            text-align: center;
            padding: 20px;
        }
        
        .qr-label {
            font-weight: bold;
        }
        
        .highlight-yellow {
            color: #f1c40f;
        }
        
        .qr-modal-body {
            padding: 10px;
        }
        
        #progressBar {
            height: 5px;
            background-color: #f1c40f;
        }
    </style>
    </head>

    <body>
        <main class="hocvienthanhtoan container my-5">
            <div class="payment-container fade-in">
                <div class="payment-card">
                    <!-- Header -->
                    <div class="payment-header">
                        <h2><i class="fas fa-credit-card me-2"></i>Xác nhận
                            thanh toán</h2>
                        <div class="transaction-id">
                            <i class="fas fa-receipt"></i>
                            <strong>Mã giao dịch: </strong>
                            <span id="giaoDichId"
                                th:text="'GLOBALEDU' + ${giaoDichId}">ID</span>
                            <span id="rawGiaoDichId" th:text="${giaoDichId}"
                                hidden></span>
                        </div>
                    </div>

                    <!-- Course Section -->
                    <div class="course-section p-4">
                        <h5 class="section-title">
                            <i class="fas fa-graduation-cap"></i> Các khóa học
                            bạn đã chọn
                        </h5>

                        <table class="table course-table">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-book me-2"></i>Tên khóa
                                        học
                                    </th>
                                    <th class="text-end"><i
                                            class="fas fa-tag me-2"></i>Học phí
                                        gốc
                                    </th>
                                    <th class="text-end"><i
                                            class="fas fa-money-bill-wave me-2"></i>Học
                                        phí phải trả</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="kh : ${dsKhoaHoc}">
                                    <td th:text="${kh.tenKhoaHoc}">Tên khóa học
                                    </td>
                                    <td class="text-end price-original"
                                        th:text="${#numbers.formatDecimal(kh.giagoc,1,'POINT',0,'COMMA')} + ' ₫'">0
                                        ₫
                                    </td>
                                    <td class="text-end price-current"
                                        th:text="${#numbers.formatDecimal(kh.giaHienTai,1,'POINT',0,'COMMA')} + ' ₫'">0
                                        ₫
                                    </td>
                                </tr>

                                <!-- Nếu khuyến mãi hết hạn -->
                                <tr th:each="kh : ${dsKhoaHoc}"
                                    th:if="${!kh.isKhuyenMaiDangApDung()} and ${kh.giaKhuyenMai != null}">
                                    <td colspan="3" class="text-warning small">
                                        Khuyến mãi đã hết. Giá hiện tại:
                                        <span
                                            th:text="${#numbers.formatDecimal(kh.giaHienTai,1,'POINT',0,'COMMA')} + ' ₫'">0
                                            ₫</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Total Section -->
                        <div class="total-section">
                            <div
                                class="d-flex justify-content-between align-items-center mb-3">
                                <span class="fs-5 fw-semibold text-muted">Tổng
                                    cộng:</span>
                                <div class="total-amount pulse"
                                    id="tongTienText"
                                    th:text="${#numbers.formatDecimal(tongTien,0,'POINT',0,'COMMA')} + ' ₫'">0
                                    ₫
                                </div>
                            </div>

                            <div class="security-badge">
                                <i class="fas fa-shield-alt"></i> Thanh toán an
                                toàn & bảo mật
                            </div>

                            <button id="xacNhanBtn" class="confirm-btn mt-4">
                                <i class="fas fa-lock me-2"></i>
                                Xác nhận thanh toán
                            </button>

                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Bạn sẽ nhận được email xác nhận sau khi
                                    thanh toán thành công
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL QR -->
            <div class="modal fade" id="qrModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body qr-modal-body">
                            <img id="qrImage" src alt="QR Code"
                                style="width: 260px;" class="d-block mx-auto" />
                            <p class="qr-label mt-2">Mã QR thanh toán</p>
                            <p><strong>Số tiền:</strong> <span id="qrTien"
                                    class="highlight-yellow">--</span> ₫</p>
                            <p><strong>Nội dung (bắt buộc):</strong> <span
                                    id="qrNoiDung"
                                    class="highlight-yellow">--</span></p>
                            <p><strong>Người thụ hưởng:</strong> TRAN NGOC THAI
                            </p>
                            <div class="progress my-2">
                                <div id="progressBar" class="progress-bar"
                                    role="progressbar"
                                    style="width: 100%"></div>
                            </div>
                            <div class="small">Đang chờ thanh toán <span
                                    id="countdown">30:00</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL SUCCESS -->
            <div class="modal fade" id="successModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered"
                    style="max-width: 300px;">
                    <div class="modal-content text-center p-4"
                        style="background: #2c2f7b; border-radius: 16px; color: white;">
                        <div class="mb-3" style="font-size: 48px;">✅</div>
                        <h5 class="fw-bold mb-3 text-warning">Thanh toán thành
                            công
                        </h5>
                        <div class="progress" style="height: 25px;">
                            <div id="redirectProgress"
                                class="progress-bar bg-light text-dark"
                                style="width: 100%">Bắt đầu sau 5s</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL FAIL -->
            <div class="modal fade" id="failModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered"
                    style="max-width: 300px;">
                    <div class="modal-content text-center p-4"
                        style="background: #721c24; border-radius: 16px; color: white;">
                        <div class="mb-3" style="font-size: 48px;">❌</div>
                        <h5 class="fw-bold mb-3 text-warning">Thanh toán thất
                            bại
                        </h5>
                        <div class="progress" style="height: 25px;">
                            <div id="failRedirectProgress"
                                class="progress-bar bg-light text-dark"
                                style="width: 100%">Trở về trang chủ sau 5s
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script th:inline="javascript">
            const isLoggedIn = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;

            let countdownSeconds = 180;
            let isSuccess = false;
            let isProcessing = false;
            let intervalId;

            document.getElementById("xacNhanBtn").addEventListener("click", function(e) {
                e.preventDefault();

                const giaoDichIdHienThi = document.getElementById("giaoDichId").textContent.trim(); // Prefixed: GLOBALEDU_+
                const rawGiaoDichId = document.getElementById("rawGiaoDichId").textContent.trim(); // Raw ID
                const tongTienText = document.getElementById("tongTienText").textContent;
                const soTien = tongTienText.replace(/[₫\s,.]/g, "").trim();
                const khoaHocIds = /*[[${khoaHocIds}]]*/ [];

                const qrUrl = `https://img.vietqr.io/image/Vietinbank-102884955390-compact.jpg?amount=${soTien}&addInfo=${encodeURIComponent(giaoDichIdHienThi)}`;
                document.getElementById("qrImage").src = qrUrl;
                document.getElementById("qrTien").textContent = `${parseInt(soTien).toLocaleString()} `;
                document.getElementById("qrNoiDung").textContent = giaoDichIdHienThi;

                countdownSeconds = 180;
                updateCountdown();
                document.getElementById("progressBar").style.width = "100%";

                const qrModal = new bootstrap.Modal(document.getElementById("qrModal"));
                qrModal.show();

                intervalId = setInterval(() => {
                    if (!isSuccess) {
                        checkPayment(soTien, rawGiaoDichId, khoaHocIds);
                        updateCountdown();
                    }
                }, 1000);
            });

            function updateCountdown() {
                if (countdownSeconds <= 0) {
                    clearInterval(intervalId);
                    if (!isSuccess) showFailModal();
                    return;
                }

                countdownSeconds--;
                let minutes = Math.floor(countdownSeconds / 60);
                let seconds = countdownSeconds % 60;
                document.getElementById("countdown").textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
                const percent = (countdownSeconds / 180) * 100;
                document.getElementById("progressBar").style.width = `${percent}%`;
            }

            async function showFailModal() {
                const qrModal = bootstrap.Modal.getInstance(document.getElementById("qrModal"));
                qrModal.hide();

                // Gửi trạng thái thất bại về backend
                await fetch("/hoc-vien/api/thanh-toan/that-bai", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        giaoDichId: document.getElementById("rawGiaoDichId").textContent.trim(),
                        khoaHocIds: /*[[${khoaHocIds}]]*/ [] // đảm bảo danh sách ID khóa học được truyền vào
                    })
                });

                const failModal = new bootstrap.Modal(document.getElementById("failModal"));
                failModal.show();

                let countdown = 5;
                const progress = document.getElementById("failRedirectProgress");
                const interval = setInterval(() => {
                    countdown--;
                    progress.style.width = `${(countdown / 5) * 100}%`;
                    progress.textContent = `Trở về trang chủ sau ${countdown}s`;
                    if (countdown <= 0) {
                        clearInterval(interval);
                        window.location.href = "/";
                    }
                }, 1000);
            }



            function removeDiacritics(str) {
                return str.normalize("NFD").replace(/[̀-ͯ]/g, "");
            }

            async function checkPayment(soTien, giaoDichId, khoaHocIds) {
                if (isSuccess || isProcessing) return;
                isProcessing = true;

                try {
                    const res = await fetch("https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjHtDrFbPruQI5SLLl9wUy7JAnF4ubj-kf38YMRu-LCqrNs75voxa8Mg9QoyY6SKfpjaNpdP8bX9GeRvOwxrOkJXcClqUcV9mPc5iRsO0beb0r3UTxj_B_9rmN-q7Yo6vTefCXqqgt8a2ab3moBw5D_pKwip9W8xnaHdGrJEQzSC0rhxJOl6V5F9exxkGk1CtgGwqXuLzG0kqPSFtt-UL0PJA9BPQdLRrKgMjAn_h-gBcyp-8L8vza3JO3BrQmXQn-rZC4VORcWnqNYyXiyqCBGUNAZB7FlXvaUu1YA&lib=Mnnf4g9ZZha1gHERNv6b7Cs9R-haV7NiA");
                    const data = await res.json();
                    const last = data.data[data.data.length - 1];
                    const giaTri = last["Giá trị"];
                    const moTa = removeDiacritics(last["Mô tả"].trim().toLowerCase());
                    const normalizedND = "globaledu" + removeDiacritics(giaoDichId.trim().toLowerCase());

                    console.log("Kiểm tra thanh toán:", {
                        giaoDichId: giaoDichId,
                        soTien: soTien,
                        giaTri: giaTri,
                        moTa: moTa,
                        normalizedND: normalizedND
                    });

                    if (giaTri == soTien && moTa.includes(normalizedND)) {
                        isSuccess = true;
                        clearInterval(intervalId);

                        const qrModalEl = document.getElementById("qrModal");
                        const qrModal = bootstrap.Modal.getInstance(qrModalEl);
                        if (qrModal) qrModal.hide();

                        // ✅ Hiện modal thành công ngay lập tức
                        const successModal = new bootstrap.Modal(document.getElementById("successModal"));
                        successModal.show();

                        // ✅ Bắt đầu đếm ngược chuyển hướng ngay
                        let countdown = 5;
                        const progress = document.getElementById("redirectProgress");

                        const redirectInterval = setInterval(() => {
                            countdown--;
                            const percent = (countdown / 5) * 100;
                            progress.style.width = `${percent}%`;
                            progress.textContent = `Bắt đầu sau ${countdown}s`;

                            if (countdown <= 0) {
                                clearInterval(redirectInterval);
                                console.log("Thanh toán thành công, chuyển hướng...");
                                window.location.href = "/hoc-vien/hoc-tap?tab=hoc-tap";
                            }
                        }, 1000);

                        // ✅ Gửi thông tin thanh toán (không chờ)
                        fetch("/hoc-vien/api/thanh-toan/thanh-cong", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                giaoDichId: giaoDichId,
                                tongTien: soTien,
                                khoaHocIds: khoaHocIds
                            })
                        }).catch(e => console.error("Lỗi gửi thanh toán thành công:", e));

                        // ✅ Xoá khóa học khỏi giỏ hàng (không chờ)
                        if (isLoggedIn && Array.isArray(khoaHocIds)) {
                            for (const id of khoaHocIds) {
                                fetch(`/gio-hang/xoa/${id}`, {
                                    method: 'DELETE'
                                }).catch(e => console.warn("Lỗi xóa giỏ hàng:", e));
                            }
                        }
                    }

                } catch (err) {
                    console.error("Lỗi kiểm tra thanh toán:", err);
                } finally {
                    isProcessing = false;
                }
            }
        </script>
        </main>
    </body>

</html>