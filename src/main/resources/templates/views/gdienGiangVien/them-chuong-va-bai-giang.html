<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{/views/gdienChung/templateChung.html::view(~{::main}, ~{::title})}">

    <head>
        <meta charset="UTF-8">
        <title>C√°c b∆∞·ªõc t·∫°o kh√≥a h·ªçc</title>
    </head>

    <body>
        <main class=" tao-khoa-hoc-page container py-5"
            style="padding-left: 100px; padding-right: 100px;">
            <div class="tieude">
                <h3>‚ûïT·∫°o n·ªôi dung kh√≥a h·ªçc</h3>
            </div>

            <!-- Container th√¥ng b√°o -->
            <div class="my-3">
                <!-- Th√¥ng b√°o th√†nh c√¥ng -->
                <div th:if="${thongbao}"
                    class="alert alert-success alert-dismissible fade show shadow-sm rounded px-4 py-3 border-0"
                    role="alert" style="background-color: #e6f4ea;">
                    <span th:text="${thongbao}" class="fw-medium">Th√¥ng
                        b√°o</span>
                    <button type="button" class="btn-close"
                        data-bs-dismiss="alert" aria-label="ƒê√≥ng"></button>
                </div>

                <!-- Th√¥ng b√°o l·ªói -->
                <div th:if="${loi}"
                    class="alert alert-danger alert-dismissible fade show shadow-sm rounded px-4 py-3 border-0"
                    role="alert" style="background-color: #fbeaea;">
                    <span th:text="${loi}" class="fw-medium">L·ªói</span>
                    <button type="button" class="btn-close"
                        data-bs-dismiss="alert" aria-label="ƒê√≥ng"></button>
                </div>

                <!-- Hi·ªÉn th·ªã l·ªói -->
                <div th:if="${loidinhdang}" th:utext="${loidinhdang}"
                    class="alert alert-danger"></div>
            </div>

            <form th:if="${chuongForm != null}" id="form-tao-khoa-hoc"
                th:action="@{/giangvien/them-moi-khoa-hoc/luu-chuong-va-baigiang}"
                th:object="${chuongForm}" method="post">
                <input type="hidden" name="khoahocId"
                    th:value="${khoahoc.khoahocId}" />

                <div
                    class="d-flex justify-content-between align-items-center mt-3"
                    th:if="${khoahoc.trangThai.name() == 'DRAFT'}">
                    <a href="#"
                        class="text-decoration-none text-primary fw-bold"
                        onclick="xuLyTroVeTrangChu(event)">
                        ‚Üê V·ªÅ b·∫£ng ƒëi·ªÅu khi·ªÉn
                    </a>
                    <button id="btnLuuBanNhaps1" type="submit"
                        class="btn themkhoahoc-btn">
                        <i class="fas fa-upload me-2"></i>L∆∞u b·∫£n nh√°p
                    </button>
                </div>

                <div id="chuong-container"
                    th:if="${chuongForm.chuongs != null}">
                    <div th:each="chuong, cStat : ${chuongForm.chuongs}"
                        class="card mt-4 chuong-item"
                        th:attr="data-chuong-id=${chuong.chuongId}"
                        style="background-color: #E9ECEF;">
                        <div
                            class="card-header d-flex justify-content-between align-items-center">
                            <strong class="chuong-title"
                                th:text="'Ph·∫ßn ' + ${cStat.index + 1}">Ph·∫ßn</strong>
                            <div class="d-flex gap-2">
                                <button type="submit"
                                    class="btn btn-sm btn-success"
                                    th:name="saveChuongIndex"
                                    th:value="${cStat.index}"
                                    title="L∆∞u ch∆∞∆°ng n√†y">
                                    <i class="bi bi-save"></i>
                                </button>

                                <button type="button"
                                    class="btn btn-sm btn-outline-secondary btn-toggle-mota"
                                    data-bs-toggle="tooltip"
                                    data-bs-trigger="hover"
                                    data-bs-placement="top" title="M√¥ t·∫£">
                                    <i class="bi bi-plus-circle"></i>
                                </button>

                                <button type="button"
                                    class="btn btn-sm btn-danger"
                                    th:onclick="'moModalXoaChuong(' + ${chuong.chuongId} + ')'">
                                    <i class="bi bi-trash"></i>
                                </button>

                                <button type="button"
                                    class="btn btn-sm btn-outline-dark btn-toggle-chuong"
                                    onclick="toggleChuongNoiDung(this)"
                                    title="Thu g·ªçn / M·ªü r·ªông">
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                            </div>
                        </div>

                        <div class="card-body">
                            <label class="form-label mb-2">üìöT√™n ch∆∞∆°ng:</label>
                            <input type="text" class="form-control mb-3"
                                th:name="'chuongs[' + ${cStat.index} + '].tenchuong'"
                                th:value="${chuong.tenchuong}"
                                placeholder="nh·∫≠p t√™n ch∆∞∆°ng" />

                            <input type="hidden"
                                th:name="'chuongs[' + ${cStat.index} + '].chuongId'"
                                th:value="${chuong.chuongId}" />

                            <div class="mo-ta-chuong mt-2 mb-3"
                                style="display:none;">
                                <label class="form-label mb-2">üìò M√¥ t·∫£
                                    ch∆∞∆°ng:</label>
                                <textarea class="form-control" rows="2"
                                    th:name="'chuongs[' + ${cStat.index} + '].mota'"
                                    th:text="${chuong.mota}"
                                    placeholder="nh·∫≠p m√¥ t·∫£ ch∆∞∆°ng"></textarea>
                            </div>

                            <div class="bai-giang-container">
                                <div
                                    th:each="baiGiang, bStat : ${chuong.baiGiangs}"
                                    class="baigiang-item border p-3 rounded mb-3">

                                    <input type="hidden"
                                        th:name="'chuongs[' + ${cStat.index} + '].baiGiangs[' + ${bStat.index} + '].baiGiangId'"
                                        th:value="${baiGiang.baiGiangId}" />

                                    <div
                                        class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                                        <strong
                                            class="baigiang-title flex-grow-1"
                                            th:text="'B√†i gi·∫£ng ' + ${bStat.index + 1}">B√†i
                                            gi·∫£ng</strong>

                                        <div class="d-flex gap-2">
                                            <button type="button"
                                                class="btn btn-outline-primary btn-sm btn-chon-loai"
                                                data-value="VIDEO">Video</button>
                                            <button type="button"
                                                class="btn btn-outline-primary btn-sm btn-chon-loai"
                                                data-value="TAILIEU">B√†i
                                                vi·∫øt</button>
                                            <button type="button"
                                                class="btn btn-outline-primary btn-sm btn-chon-loai"
                                                data-value="TRACNGHIEM">Tr·∫Øc
                                                nghi·ªám</button>
                                        </div>

                                        <!-- ‚úÖ N√∫t l∆∞u b√†i gi·∫£ng -->
                                        <button type="submit"
                                            class="btn btn-sm btn-success"
                                            th:name="saveBaiGiang"
                                            th:value="${cStat.index + '-' + bStat.index}"
                                            title="L∆∞u b√†i gi·∫£ng n√†y">
                                            <i class="bi bi-save"></i>
                                        </button>

                                        <!-- N·∫øu ƒë√£ c√≥ ID ‚Üí d√πng modal x√°c nh·∫≠n -->
                                        <button type="button"
                                            class="btn btn-sm btn-outline-danger"
                                            th:if="${baiGiang.baiGiangId != null}"
                                            th:onclick="'moModalXoaBaiGiang(' + ${baiGiang.baiGiangId} + ')'"
                                            title="X√≥a b√†i gi·∫£ng"
                                            data-bs-toggle="tooltip">
                                            <i class="bi bi-trash"></i>
                                        </button>

                                    </div>

                                    <label class="form-label mb-2">üìù T√™n b√†i
                                        h·ªçc:</label>
                                    <input type="text" class="form-control mb-2"
                                        th:name="'chuongs[' + ${cStat.index} + '].baiGiangs[' + ${bStat.index} + '].tenBaiGiang'"
                                        th:value="${baiGiang.tenBaiGiang}"
                                        placeholder="nh·∫≠p t√™n b√†i h·ªçc" />

                                    <input type="hidden"
                                        class="loai-bai-giang-input"
                                        th:name="'chuongs[' + ${cStat.index} + '].baiGiangs[' + ${bStat.index} + '].loaiBaiGiang'"
                                        th:value="${baiGiang.loaiBaiGiang}" />

                                    <label class="form-label mb-2">üé¨ N·ªôi
                                        dung:</label>
                                    <textarea class="form-control"
                                        th:name="'chuongs[' + ${cStat.index} + '].baiGiangs[' + ${bStat.index} + '].mota'"
                                        th:text="${baiGiang.mota}"
                                        placeholder="nh·∫≠p m√¥ t·∫£ n·ªôi dung"></textarea>

                                    <!-- VIDEO -->
                                    <div class="video-fields mt-2"
                                        th:style="${baiGiang.loaiBaiGiang?.name() == 'VIDEO'} ? 'display: block;' : 'display: none;'">
                                        <label
                                            class="form-label mb-2"><strong>üé•
                                                ƒê∆∞·ªùng
                                                d·∫´n video:</strong></label>
                                        <input type="text"
                                            class="form-control mb-2"
                                            th:name="'chuongs[' + ${cStat.index} + '].baiGiangs[' + ${bStat.index} + '].videoBaiGiang.url_video'"
                                            th:value="${baiGiang.videoBaiGiang?.url_video}"
                                            placeholder="https://..."
                                            pattern="^(https?:\/\/)?(www\.youtube\.com|youtu\.be)\/.+$"
                                            title="Link video c·ªßa b·∫°n kh√¥ng h·ª£p l·ªá (v√≠ d·ª•: https://youtu.be/abc123)"
                                            th:disabled="${baiGiang.loaiBaiGiang?.name() != 'VIDEO'}" />
                                        <p class="m-2"><i>B·∫°n h√£y g·∫Øn ƒë∆∞·ªùng d·∫´n
                                                video c·ªßa b·∫°n v√†o ƒë√¢y.</i></p>
                                    </div>

                                    <!-- B√ÄI VI·∫æT -->
                                    <div class="baiviet-fields mt-2"
                                        th:style="${baiGiang.loaiBaiGiang?.name() == 'TAILIEU'} ? 'display: block;' : 'display: none;'">

                                        <label class="form-label mb-2">
                                            <strong>üìÑ N·ªôi
                                                dung t√†i li·ªáu:</strong></label>
                                        <textarea class="form-control"
                                            th:name="'chuongs[' + ${cStat.index} + '].baiGiangs[' + ${bStat.index} + '].baiViet.noidung'"
                                            th:text="${baiGiang.baiViet?.noidung}"
                                            placeholder="N·ªôi dung b√†i vi·∫øt"
                                            th:disabled="${baiGiang.loaiBaiGiang?.name() != 'TAILIEU'}"></textarea>
                                        <p class="m-2"><i>ƒêi·ªÅn chi ti·∫øt n·ªôi dung
                                                gi·∫£ng d·∫°y ho·∫∑c ph·∫ßn b√†i t·∫≠p k√®m
                                                theo.</i></p>
                                    </div>

                                    <div class="tracnghiem-fields mt-2"
                                        th:style="${baiGiang.loaiBaiGiang?.name() == 'TRACNGHIEM'} ? 'display:block;' : 'display:none;'">

                                        <!-- <a
                                            th:href="@{/giangvien/cau-hoi/them(baiGiangId=${baiGiang.baiGiangId})}"
                                            class="btn btn-outline-primary btn-sm">
                                            ‚ûï Th√™m ho·∫∑c s·ª≠a c√¢u h·ªèi
                                        </a> -->

                                        <a
                                            th:href="@{/giangvien/cau-hoi/them(baiGiangId=${baiGiang.baiGiangId})}"
                                            class="btn btn-outline-primary btn-sm"
                                            onclick="saveScrollPosition(this)">
                                            ‚ûï Th√™m ho·∫∑c s·ª≠a c√¢u h·ªèi
                                        </a>

                                    </div>

                                </div>
                            </div>

                            <button type="button"
                                class="btn btn-outline-secondary mt-2"
                                onclick="themBaiGiang(this)">
                                + M·ª•c gi√°o tr√¨nh
                            </button>
                        </div>
                    </div>
                </div>

                <div
                    class="d-flex justify-content-between align-items-center mt-3">
                    <!-- Nh√≥m 2 n√∫t ƒë·∫ßu b√™n tr√°i -->
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-primary"
                            onclick="themChuong()">+ Ph·∫ßn</button>
                        <!-- <button type="submit" class="btn themkhoahoc-btn"> <i
                                class="fas fas fa-upload me-2"></i>L∆∞u
                            b·∫£n nh√°p</button> -->

                        <div th:if="${khoahoc.trangThai.name() == 'DRAFT'}">
                            <button id="btnLuuBanNhaps" type="submit"
                                class="btn themkhoahoc-btn">
                                <i class="fas fas fa-upload me-2"></i>L∆∞u b·∫£n
                                nh√°p
                            </button>
                        </div>
                    </div>

                    <!-- N√∫t b√™n ph·∫£i -->
                    <button type="button" class="btn themkhoahoc-btn"
                        th:onclick="|window.location.href='/giangvien/them-moi-khoa-hoc/gia?khoahocId=${khoahoc.khoahocId}'|">
                        <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i b∆∞·ªõc 2
                    </button>
                </div>
            </form>

            <div id="yeuCauDuyetContainer" style="margin-top: 30px;">
                <div style="margin-bottom: 10px;">
                    <input type="checkbox" id="dongYChinhSach">
                    <label for="dongYChinhSach" style="cursor:pointer;">
                        T√¥i ƒë·ªìng √Ω v·ªõi <strong>ch√≠nh s√°ch</strong>: Sau khi kh√≥a
                        h·ªçc xu·∫•t b·∫£n,
                        b·∫°n s·∫Ω <strong>kh√¥ng th·ªÉ c·∫≠p nh·∫≠t</strong> kh√≥a h·ªçc n·ªØa.
                    </label>
                </div>

                <button type="button" class="btn" id="btnYeuCauDuyet"
                    style="background-color: #16203b; color: white;"
                    th:data-khoahoc-id="${khoahoc.khoahocId}" disabled>
                    <i class="fas fa-paper-plane"></i>
                    Y√™u c·∫ßu duy·ªát
                </button>
            </div>

            <!-- Modal x√°c nh·∫≠n x√≥a ch∆∞∆°ng -->
            <div class="modal fade" id="modalXoaChuong" tabindex="-1"
                aria-labelledby="xoaChuongLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <form method="post"
                        th:action="@{/giangvien/them-moi-khoa-hoc/xoa-chuong}">
                        <input type="hidden" name="chuongId"
                            id="inputChuongIdXoa" />
                        <input type="hidden" name="khoahocId"
                            th:value="${khoahoc.khoahocId}" />
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="xoaChuongLabel">X√°c
                                    nh·∫≠n x√≥a ch∆∞∆°ng</h5>
                                <button type="button" class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="ƒê√≥ng"></button>
                            </div>
                            <div class="modal-body">
                                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng n√†y? T·∫•t c·∫£ b√†i
                                gi·∫£ng trong ch∆∞∆°ng c≈©ng s·∫Ω b·ªã x√≥a.
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">H·ªßy</button>
                                <button type="submit"
                                    class="btn btn-danger">X√≥a</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal x√°c nh·∫≠n x√≥a b√†i gi·∫£ng -->
            <div class="modal fade" id="modalXoaBaiGiang" tabindex="-1"
                aria-labelledby="xoaBaiGiangLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <form method="post"
                        th:action="@{/giangvien/them-moi-khoa-hoc/xoa-baigiang}">
                        <input type="hidden" name="baiGiangId"
                            id="inputBaiGiangIdXoa" />
                        <input type="hidden" name="khoahocId"
                            th:value="${khoahoc.khoahocId}" />
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"
                                    id="xoaBaiGiangLabel">X√°c nh·∫≠n x√≥a b√†i gi·∫£ng
                                </h5>
                                <button type="button" class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="ƒê√≥ng"></button>
                            </div>
                            <div class="modal-body">
                                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i gi·∫£ng n√†y?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">H·ªßy</button>
                                <button type="submit"
                                    class="btn btn-danger">X√≥a</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Template ·∫©n -->
            <template id="chuong-template">
                <div class="card mt-4 chuong-item"
                    style="background-color: #E9ECEF;">
                    <div
                        class="card-header d-flex justify-content-between align-items-center">
                        <strong class="chuong-title">Ph·∫ßn</strong>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-sm btn-success"
                                name="saveChuongIndex" value="__index__"
                                title="L∆∞u ch∆∞∆°ng n√†y">
                                <i class="bi bi-save"></i>
                            </button>

                            <button type="button"
                                class="btn btn-sm btn-outline-secondary btn-toggle-mota"
                                data-bs-toggle="tooltip"
                                data-bs-trigger="hover"
                                data-bs-placement="top" title="M√¥ t·∫£">
                                <i class="bi bi-plus-circle"></i>
                            </button>

                            <button type="button" class="btn btn-sm btn-danger"
                                onclick="xoaChuong(this)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="card-body">
                        <label class="form-label mb-2">üìö T√™n ch∆∞∆°ng:</label>
                        <input type="text" name="chuongs[__index__].tenchuong"
                            class="form-control mb-3"
                            placeholder="nh·∫≠p t√™n ch∆∞∆°ng">

                        <div class="mo-ta-chuong mt-2 mb-3"
                            style="display: none;">
                            <label class="form-label mb-2">üìò M√¥ t·∫£
                                ch∆∞∆°ng:</label>
                            <textarea class="form-control"
                                name="chuongs[__index__].mota"
                                rows="2"
                                placeholder="nh·∫≠p m√¥ t·∫£ ch∆∞∆°ng"></textarea>
                        </div>

                        <div class="bai-giang-container"></div>
                        <button type="button"
                            class="btn btn-outline-secondary mt-2"
                            onclick="themBaiGiang(this)">+ M·ª•c gi√°o
                            tr√¨nh</button>
                    </div>
                </div>
            </template>

            <template id="baigiang-template">
                <div class="baigiang-item border p-3 rounded mb-3">
                    <div
                        class="d-flex justify-content-between align-items-center mb-2">
                        <strong class="baigiang-title">B√†i gi·∫£ng </strong>
                        <div class="d-flex gap-2">
                            <!-- C√°c n√∫t ch·ªçn lo·∫°i b√†i gi·∫£ng -->

                            <div class="d-flex gap-2">
                                <button type="button"
                                    class="btn btn-outline-primary btn-sm btn-chon-loai"
                                    data-value="VIDEO">Video</button>
                                <button type="button"
                                    class="btn btn-outline-primary btn-sm btn-chon-loai"
                                    data-value="TAILIEU">B√†i
                                    vi·∫øt</button>
                                <button type="button"
                                    class="btn btn-outline-primary btn-sm btn-chon-loai"
                                    data-value="TRACNGHIEM">Tr·∫Øc
                                    nghi·ªám</button>
                            </div>

                            <!-- ‚úÖ N√∫t l∆∞u b√†i gi·∫£ng -->
                            <button type="submit"
                                class="btn btn-sm btn-success"
                                name="saveBaiGiang"
                                value="__cIndex__-__bIndex__"
                                title="L∆∞u b√†i gi·∫£ng n√†y">
                                <i class="bi bi-save"></i>
                            </button>

                            <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                onclick="xoaBaiGiang(this)"
                                title="X√≥a b√†i gi·∫£ng"
                                data-bs-toggle="tooltip">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>

                    <label class="form-label mb-2">üìù T√™n b√†i h·ªçc:</label>
                    <input type="text"
                        name="chuongs[__cIndex__].baiGiangs[__bIndex__].tenBaiGiang"
                        class="form-control mb-2"
                        placeholder="nh·∫≠p t√™n b√†i h·ªçc">

                    <input type="hidden"
                        name="chuongs[__cIndex__].baiGiangs[__bIndex__].loaiBaiGiang"
                        class="loai-bai-giang-input" value />

                    <label class="form-label mb-2">üé¨ N·ªôi dung:</label>
                    <textarea
                        name="chuongs[__cIndex__].baiGiangs[__bIndex__].mota"
                        class="form-control"
                        placeholder="nh·∫≠p m√¥ t·∫£ n·ªôi dung"></textarea>

                    <!-- VIDEO -->
                    <div class="video-fields mt-2">
                        <label class="form-label mb-2"><strong>üé• ƒê∆∞·ªùng d·∫´n
                                video:</strong></label>
                        <input type="text"
                            name="chuongs[__cIndex__].baiGiangs[__bIndex__].videoBaiGiang.url_video"
                            class="form-control mb-2"
                            placeholder="https://..."
                            pattern="^(https?:\/\/)?(www\.youtube\.com|youtu\.be)\/.+$"
                            title="Link video c·ªßa b·∫°n kh√¥ng h·ª£p l·ªá (v√≠ d·ª•: https://youtu.be/abc123)">
                        <p class="m-2"><i>B·∫°n h√£y g·∫Øn ƒë∆∞·ªùng d·∫´n video c·ªßa b·∫°n
                                v√†o ƒë√¢y.</i></p>
                    </div>

                    <!-- B√ÄI VI·∫æT -->
                    <div class="baiviet-fields mt-2" style="display: none;">

                        <label class="form-label mb-2"><strong>üìÑ N·ªôi dung t√†i
                                li·ªáu:</strong></label>
                        <textarea
                            name="chuongs[__cIndex__].baiGiangs[__bIndex__].baiViet.noidung"
                            class="form-control"
                            placeholder="N·ªôi dung b√†i vi·∫øt"
                            disabled></textarea>
                        <p class="m-2"><i>ƒêi·ªÅn chi ti·∫øt
                                n·ªôi dung
                                gi·∫£ng d·∫°y ho·∫∑c ph·∫ßn b√†i t·∫≠p k√®m theo.</i></p>
                    </div>

                    <!-- TR·∫ÆC NGHI·ªÜM -->
                    <div class="tracnghiem-fields mt-2" style="display: none;">

                        <input type="hidden"
                            name="chuongs[__cIndex__].baiGiangs[__bIndex__].tracNghiem.tracnghiemId"
                            value />

                        <!-- N√∫t chuy·ªÉn trang ƒë·ªÉ th√™m/s·ª≠a c√¢u h·ªèi -->
                        <a href="#" class="btn btn-outline-primary btn-sm mt-2"
                            onclick="return false;">
                            ‚ûï Th√™m ho·∫∑c s·ª≠a c√¢u h·ªèi
                        </a>
                    </div>
                </div>
            </template>
            <script th:src="@{/js/themkhoahoc.js}"></script>
            <style>
            p i {
                font-size: 13px;
            }
            
            .tieude {
                width: 355px;
                padding: 5px;
                border: 1px solid #ccc;
                border-left: 5px solid #0c498a;
                background: #f9f9f9;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                color: #0c498a;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                margin-bottom: 20px;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
        </style>

            <script>
            document.addEventListener("DOMContentLoaded", function() {
                // G·ªçi h√†m kh√¥i ph·ª•c tr·∫°ng th√°i thu g·ªçn khi load l·∫°i trang
                restoreChuongCollapseState();

                // G·∫Øn s·ª± ki·ªán toggle cho t·∫•t c·∫£ n√∫t toggle
                document.querySelectorAll('.btn-toggle-chuong').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        toggleChuongNoiDung(btn);
                    });
                });
            });

            function toggleChuongNoiDung(button) {
                const chuongItem = button.closest('.chuong-item');
                const cardBody = chuongItem.querySelector('.card-body');
                const icon = button.querySelector('i');
                const chuongId = chuongItem.dataset.chuongId;

                const collapsedChuongs = JSON.parse(localStorage.getItem('collapsedChuongs')) || [];

                if (cardBody.style.display === "none") {
                    cardBody.style.display = "block";
                    icon.classList.remove('bi-chevron-right');
                    icon.classList.add('bi-chevron-down');

                    // B·ªè kh·ªèi danh s√°ch thu g·ªçn
                    const index = collapsedChuongs.indexOf(chuongId);
                    if (index !== -1) collapsedChuongs.splice(index, 1);
                } else {
                    cardBody.style.display = "none";
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chevron-right');

                    // Th√™m v√†o danh s√°ch thu g·ªçn n·∫øu ch∆∞a c√≥
                    if (!collapsedChuongs.includes(chuongId)) {
                        collapsedChuongs.push(chuongId);
                    }
                }

                localStorage.setItem('collapsedChuongs', JSON.stringify(collapsedChuongs));
            }

            function restoreChuongCollapseState() {
                const collapsedChuongs = JSON.parse(localStorage.getItem('collapsedChuongs')) || [];

                collapsedChuongs.forEach(function(chuongId) {
                    const chuongItem = document.querySelector(`.chuong-item[data-chuong-id="${chuongId}"]`);
                    if (chuongItem) {
                        const cardBody = chuongItem.querySelector('.card-body');
                        const button = chuongItem.querySelector('.btn-toggle-chuong');
                        const icon = button.querySelector('i');

                        if (cardBody) {
                            cardBody.style.display = "none";
                            icon.classList.remove('bi-chevron-down');
                            icon.classList.add('bi-chevron-right');
                        }
                    }
                });
            }
        </script>

            <script>
            function saveScrollPosition(linkElement) {
                const scrollY = window.scrollY || document.documentElement.scrollTop;
                // L∆∞u scroll v√† ID b√†i gi·∫£ng (n·∫øu c·∫ßn)
                sessionStorage.setItem("scrollY", scrollY);
                sessionStorage.setItem("scrollBack", "true");

                // ƒêi·ªÅu h∆∞·ªõng th·ªß c√¥ng
                window.location.href = linkElement.getAttribute("href");
                return false; // ngƒÉn redirect m·∫∑c ƒë·ªãnh
            }

            window.addEventListener("DOMContentLoaded", () => {
                if (sessionStorage.getItem("scrollBack") === "true") {
                    const scrollY = sessionStorage.getItem("scrollY");
                    if (scrollY !== null) {
                        window.scrollTo({
                            top: parseInt(scrollY),
                            behavior: "smooth"
                        });
                    }
                    // Clear ƒë·ªÉ kh√¥ng scroll l·∫°i l·∫ßn sau
                    sessionStorage.removeItem("scrollBack");
                    sessionStorage.removeItem("scrollY");
                }
            });
        </script>

            <!-- Modal th√¥ng b√°o -->
            <div class="modal fade" id="modalThongBaoYeuCau" tabindex="-1"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="modalTitle">Th√¥ng b√°o
                            </h5>
                            <button type="button" class="btn-close"
                                data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="modalBody">
                            <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c thay b·∫±ng JS -->
                        </div>
                        <div class="modal-footer">
                            <a href="/giangvien/khoa-hoc-da-tao"
                                class="btn btn-success">V·ªÅ danh s√°ch kh√≥a
                                h·ªçc</a>
                            <button type="button" class="btn btn-secondary"
                                data-bs-dismiss="modal">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal ch∆∞a c√≥ thay ƒë·ªïi -->
            <div class="modal fade" id="modalChuaThayDoi" tabindex="-1"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header"
                            style="background-color: #2d43b1; color: #fff;">
                            <h5 class="modal-title">Th√¥ng b√°o</h5>
                            <button type="button" class="btn-close"
                                data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            B·∫°n ch∆∞a th·ª±c hi·ªán thay ƒë·ªïi g√¨ m·ªõi ƒë·ªÉ l∆∞u!
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary"
                                data-bs-dismiss="modal">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modalCanhBaoHoanThanhBaiGiang"
                tabindex="-1" aria-labelledby="modalLabelCanhBao"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-warning">
                            <h5 class="modal-title" id="modalLabelCanhBao">Ch∆∞a
                                ho√†n thi·ªán b√†i gi·∫£ng</h5>
                            <button type="button" class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="ƒê√≥ng"></button>
                        </div>
                        <div class="modal-body">
                            Vui l√≤ng ho√†n thi·ªán t·∫•t c·∫£ b√†i gi·∫£ng tr∆∞·ªõc khi y√™u
                            c·∫ßu duy·ªát kh√≥a h·ªçc.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary"
                                data-bs-dismiss="modal">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
            let originalFormData = "";

            document.addEventListener("DOMContentLoaded", function() {
                const form = document.getElementById("form-tao-khoa-hoc");
                if (form) {
                    // L∆∞u l·∫°i d·ªØ li·ªáu ban ƒë·∫ßu d∆∞·ªõi d·∫°ng chu·ªói JSON
                    originalFormData = new FormData(form);
                    originalFormData = JSON.stringify(Array.from(originalFormData.entries()));
                }

                // G·∫Øn s·ª± ki·ªán cho t·∫•t c·∫£ n√∫t submit trong form
                form.querySelectorAll("button[type='submit']").forEach(function(btn) {
                    btn.addEventListener("click", function(e) {
                        const currentFormData = new FormData(form);
                        const currentDataStr = JSON.stringify(Array.from(currentFormData.entries()));

                        if (currentDataStr === originalFormData) {
                            e.preventDefault(); // ch·∫∑n submit
                            showChuaThayDoiModal();
                        }
                    });
                });
            });
        </script>

            <script>
            function showChuaThayDoiModal() {
                const modal = new bootstrap.Modal(document.getElementById("modalChuaThayDoi"));
                modal.show();
            }
        </script>

            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const btn = document.getElementById('btnYeuCauDuyet');
                const chkChinhSach = document.getElementById('dongYChinhSach');

                if (!btn || !chkChinhSach) return;

                // B·∫≠t/t·∫Øt n√∫t theo checkbox
                chkChinhSach.addEventListener('change', function() {
                    btn.disabled = !chkChinhSach.checked;
                });

                // X·ª≠ l√Ω khi click n√∫t y√™u c·∫ßu duy·ªát
                btn.addEventListener('click', function() {
                    if (btn.disabled) return;

                    // Ki·ªÉm tra t·∫•t c·∫£ b√†i gi·∫£ng ƒë√£ ch·ªçn lo·∫°i ch∆∞a
                    const chuongItems = document.querySelectorAll(".chuong-item");
                    let chuaHoanThanh = false;

                    chuongItems.forEach(chuong => {
                        const baiGiangs = chuong.querySelectorAll(".baigiang-item");
                        baiGiangs.forEach(bai => {
                            const loai = bai.querySelector(".loai-bai-giang-input");
                            if (!loai || !loai.value) {
                                chuaHoanThanh = true;
                            }
                        });
                    });

                    if (chuaHoanThanh) {
                        // Hi·ªán modal c·∫£nh b√°o
                        const modal = new bootstrap.Modal(document.getElementById("modalCanhBaoHoanThanhBaiGiang"));
                        modal.show();
                        return;
                    }

                    // N·∫øu ƒë√£ ho√†n thi·ªán ‚Üí g·ª≠i y√™u c·∫ßu duy·ªát
                    const khoaHocId = btn.getAttribute('data-khoahoc-id');
                    const originalContent = btn.innerHTML;

                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>ƒêang g·ª≠i...';

                    fetch('/khoa-hoc/yeu-cau-duyet?id=' + encodeURIComponent(khoaHocId), {
                            method: 'POST'
                        })
                        .then(response => {
                            if (response.ok) return response.text();
                            else throw new Error('L·ªói m·∫°ng ho·∫∑c server kh√¥ng ph·∫£n h·ªìi');
                        })
                        .then(msg => {
                            // Modal th√†nh c√¥ng
                            document.getElementById('modalTitle').textContent = 'Th√†nh c√¥ng';
                            document.getElementById('modalBody').textContent = msg || 'Y√™u c·∫ßu duy·ªát ƒë√£ ƒë∆∞·ª£c g·ª≠i!';
                            const modal = new bootstrap.Modal(document.getElementById('modalThongBaoYeuCau'));
                            modal.show();

                            // ·∫®n c√°c n√∫t l∆∞u nh√°p
                            const btnLuu1 = document.getElementById('btnLuuBanNhaps1');
                            const btnLuu2 = document.getElementById('btnLuuBanNhaps');
                            if (btnLuu1) btnLuu1.style.display = 'none';
                            if (btnLuu2) btnLuu2.style.display = 'none';

                            btn.disabled = true;
                            btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>ƒê√£ g·ª≠i y√™u c·∫ßu duy·ªát';
                            btn.classList.add('disabled');

                            setTimeout(function() {
                                window.location.href = '/giangvien/khoa-hoc-da-tao';
                            }, 2000);
                        })
                        .catch(error => {
                            // Modal th·∫•t b·∫°i
                            document.getElementById('modalTitle').textContent = 'Th·∫•t b·∫°i';
                            document.getElementById('modalBody').textContent = 'G·ª≠i y√™u c·∫ßu th·∫•t b·∫°i: ' + error.message;
                            const modal = new bootstrap.Modal(document.getElementById('modalThongBaoYeuCau'));
                            modal.show();

                            // Kh√¥i ph·ª•c l·∫°i n√∫t
                            btn.disabled = false;
                            btn.innerHTML = originalContent;
                        });
                });
            });
        </script>

            <!-- Toast c·∫£nh b√°o ch∆∞a ch·ªçn lo·∫°i b√†i gi·∫£ng -->
            <div class="position-fixed end-0 p-3"
                style="z-index: 9999; bottom: 100px;">
                <div id="toastCanhBaoLoaiBaiGiang"
                    class="toast align-items-center text-white bg-danger border-0"
                    data-bs-delay="3000" role="alert" aria-live="assertive"
                    aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            Vui l√≤ng ho√†n th√†nh b√†i gi·∫£ng tr∆∞·ªõc khi th√™m b√†i
                            gi·∫£ng m·ªõi!
                        </div>
                        <button type="button"
                            class="btn-close btn-close-white me-2 m-auto"
                            data-bs-dismiss="toast" aria-label="ƒê√≥ng"></button>
                    </div>
                </div>
            </div>

            <!-- Toast c·∫£nh b√°o ch∆∞a ch·ªçn lo·∫°i b√†i gi·∫£ng m√† ·∫•n th√™m ch∆∞∆°ng -->
            <div class="position-fixed end-0 p-3"
                style="z-index: 9999; bottom: 100px;">
                <div id="toastCanhBaoLoaiBaiGiangChuong"
                    class="toast align-items-center text-white bg-danger border-0"
                    data-bs-delay="3000" role="alert" aria-live="assertive"
                    aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            Vui l√≤ng ho√†n th√†nh b√†i gi·∫£ng tr∆∞·ªõc khi th√™m ch∆∞∆°ng
                            m·ªõi!
                        </div>
                        <button type="button"
                            class="btn-close btn-close-white me-2 m-auto"
                            data-bs-dismiss="toast" aria-label="ƒê√≥ng"></button>
                    </div>
                </div>
            </div>

            <script>
            let formChanged = false;

            document.addEventListener("DOMContentLoaded", function() {
                const form = document.getElementById("form-tao-khoa-hoc");

                if (form) {
                    form.addEventListener("change", () => formChanged = true);

                    // Khi nh·∫•n submit (L∆∞u b·∫£n nh√°p ho·∫∑c Y√™u c·∫ßu duy·ªát) th√¨ reset tr·∫°ng th√°i thay ƒë·ªïi
                    form.addEventListener("submit", () => formChanged = false);
                }
            });

            function xuLyTroVeTrangChu(event) {
                event.preventDefault();

                if (formChanged) {
                    const modal = new bootstrap.Modal(document.getElementById('modalXacNhanTroVe'));
                    modal.show();
                } else {
                    window.location.href = '/giangvien/trang-giang-vien'; // <-- thay b·∫±ng URL th·∫≠t c·ªßa b·∫°n
                }
            }

            function thucHienTroVeTrangChu() {
                window.location.href = '/giangvien/trang-giang-vien'; // <-- thay b·∫±ng URL th·∫≠t c·ªßa b·∫°n
            }
        </script>

            <div class="modal fade" id="modalXacNhanTroVe" tabindex="-1"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-warning">
                            <h5 class="modal-title">X√°c nh·∫≠n</h5>
                            <button type="button" class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="ƒê√≥ng"></button>
                        </div>
                        <div class="modal-body">
                            <p>Th√¥ng tin b·∫°n v·ª´a nh·∫≠p ch∆∞a ƒë∆∞·ª£c l∆∞u. B·∫°n c√≥ ch·∫Øc
                                ch·∫Øn mu·ªën r·ªùi kh·ªèi trang n√†y kh√¥ng?</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary"
                                data-bs-dismiss="modal">·ªû l·∫°i</button>
                            <button type="button" class="btn btn-danger"
                                onclick="thucHienTroVeTrangChu()">R·ªùi
                                kh·ªèi</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </body>

</html>