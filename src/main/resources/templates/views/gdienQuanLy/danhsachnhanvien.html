<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
  th:replace="~{/views/gdienChung/templateChung.html::view(~{::main}, ~{::title})}">

  <head>
    <meta charset="UTF-8">
    <title>Quản lý nhân viên</title>
  </head>

  <body>
    <main class="quanlynhanvien">
      <div class="card-custom">
        <div class="left-panel">
          <i class="fas fa-user-tie"></i>
          <h2>Quản lý nhân viên</h2>
          <p>Thêm mới nhân viên và gửi xác thực email</p>
        </div>
        <div class="right-panel">
          <h4 class="mb-4"><i class="fas fa-user-plus"></i> Thêm nhân viên</h4>
          <form th:action="@{/admin/quanly-nhanvien/them}" method="post">
            <div class="mb-3">
              <label class="form-label">Họ và tên:</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email:</label>
              <input type="email" name="email" class="form-control" required>
            </div>
            <button type="submit" class="btn maxacthuc btn-block w-100">
              <i class="fas fa-paper-plane"></i> Thêm và Gửi xác thực
            </button>
          </form>
        </div>
      </div>

      <div class="dsach">
        <h4 class="danhsach"><i class="fas fa-users"></i> Danh sách nhân viên
        </h4>
        <table class="table table-bordered table-striped mt-3">
          <thead class="table-dark text-center">
            <tr>
              <th><i class="fas fa-sort-numeric-up"></i> STT</th>
              <th><i class="fas fa-user"></i> Họ và tên</th>
              <th><i class="fas fa-envelope"></i> Email</th>
              <th><i class="fas fa-check-circle"></i> Trạng thái</th>
              <th><i class="fas fa-cogs"></i> Hành động</th>
            </tr>
          </thead>
          <tbody class="text-center">
            <tr th:each="nv, stat : ${danhSachNhanVien}">
              <td th:text="${stat.index + 1}"></td>
              <td th:text="${nv.name}"></td>
              <td th:text="${@textUtils.maskEmail(nv.email)}">Email</td>

              <td>
                <span th:if="${nv.status}" class="badge bg-success">Hoạt
                  động</span>
                <span th:if="${!nv.status}" class="badge bg-secondary">Bị
                  khóa</span>
              </td>
              <td>
                <button type="button"
                  class="btn btn-sm btn-outline-secondary btn-toggle"
                  th:data-id="${nv.taikhoanId}" th:data-status="${nv.status}"
                  th:data-name="${nv.name}" onclick="openConfirmModal(this)"
                  th:utext="${nv.status} ? '&#128274; Khóa' : '&#128275; Mở'">
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Modal xác nhận -->
      <div class="modal fade" id="confirmModal" tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <form id="confirmForm" method="post">
              <div class="modal-header">
                <h5 class="modal-title"><i
                    class="fas fa-users-cog me-2"></i>Quản lý tài khoản nhân
                  viên
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Đóng"></button>
              </div>
              <div class="modal-body">
                <p id="confirmMessage"></p>
              </div>
              <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-outline-secondary me-2"
                  data-bs-dismiss="modal">
                  <i class="fas fa-times-circle me-1"></i> Hủy
                </button>
                <button type="submit" class="btn btn-outline-danger">
                  <i class="fas fa-check-circle me-1"></i> Xác
                  nhận
                </button>
              </div>

            </form>
          </div>
        </div>
      </div>

      <div class="toast-container position-fixed end-0 translate-middle-y"
        style="top: 50%; z-index: 1055;">
        <!-- Thành công -->
        <div id="toastSuccess" class="toast text-bg-success" role="alert"
          aria-live="assertive" aria-atomic="true" th:if="${success}">
          <div class="toast-header">
            <strong class="me-auto">✔️ Thành công</strong>
            <button type="button" class="btn-close"
              data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body" th:text="${success}">Tác vụ thành công!</div>
        </div>

        <!-- Lỗi -->
        <div id="toastError" class="toast text-bg-danger" role="alert"
          aria-live="assertive" aria-atomic="true" th:if="${error}">
          <div class="toast-header">
            <strong class="me-auto">❌ Lỗi</strong>
            <button type="button" class="btn-close"
              data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body" th:text="${error}">Có lỗi xảy ra!</div>
        </div>

        <!-- Thông báo chung -->
        <div id="toastMessage" class="toast text-bg-info" role="alert"
          aria-live="assertive" aria-atomic="true" th:if="${message}">
          <div class="toast-header">
            <strong class="me-auto">ℹ️ Thông báo</strong>
            <button type="button" class="btn-close"
              data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body" th:text="${message}">Đây là thông báo.</div>
        </div>
      </div>

      <script>
            function openConfirmModal(button) {
                const id = button.getAttribute('data-id');
                const name = button.getAttribute('data-name');
                const isActive = button.getAttribute('data-status') === 'true';

                const form = document.getElementById('confirmForm');
                form.action = `/admin/quanly-nhanvien/toggle-status-nhanvien/${id}`;

                const msg = isActive ? `Bạn có chắc chắn muốn KHÓA tài khoản "${name}"?` :
                    `Bạn có chắc chắn muốn MỞ tài khoản "${name}"?`;

                document.getElementById('confirmMessage').innerText = msg;

                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                modal.show();
            }

            window.addEventListener("DOMContentLoaded", () => {
                const successAlert = document.querySelector('.alert-success');
                if (successAlert) {
                    const modal = new bootstrap.Modal(document.getElementById('successModal'));
                    modal.show();
                }
            });
        </script>

      <script>
            window.addEventListener("DOMContentLoaded", () => {
                const toastIds = ['toastSuccess', 'toastError', 'toastMessage'];

                toastIds.forEach(id => {
                    const toastEl = document.getElementById(id);
                    if (toastEl) {
                        const toast = new bootstrap.Toast(toastEl, {
                            delay: 3000
                        });
                        toast.show();
                    }
                });
            });
        </script>

    </main>
  </body>

</html>