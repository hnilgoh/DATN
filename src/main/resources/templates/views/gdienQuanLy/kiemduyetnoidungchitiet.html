<!DOCTYPE html>
<html lang="en"
    th:replace="~{/views/gdienChung/templateChung.html::view(~{::main}, ~{::title})}">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Xem kh√≥a h·ªçc</title>
    </head>

    <body>
        <main class="xemkhoahoc"
            th:attr="data-bai-giang-id=${baiGiang.baiGiangId}">
            <div th:if="${khoaHoc != null}">
                <div class="container">
                    <div class="row gx-1">
                        <div class="col-lg-8">
                            <div class="border d-flex flex-column shadow-box"
                                id="noiDungKhoaHoc"
                                style="height: 350px; overflow-y: auto;">
                                <div th:if="${baiGiang != null}">
                                    <!-- VIDEO -->
                                    <div
                                        th:if="${baiGiang.loaiBaiGiang.name() == 'VIDEO'}">
                                        <iframe class="w-100" height="348px"
                                            th:src="${baiGiang.videoBaiGiang.url_video}"
                                            frameborder="0"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                            allowfullscreen>
                                        </iframe>
                                    </div>

                                    <!-- B√ÄI VI·∫æT -->
                                    <div
                                        th:if="${baiGiang.loaiBaiGiang.name() == 'TAILIEU'}"
                                        class="flex-grow-1 overflow-auto mt-30">
                                        <div
                                            th:utext="${baiViet.noidung}"></div>
                                    </div>

                                    <!-- TR·∫ÆC NGHI·ªÜM -->
                                    <div
                                        th:if="${baiGiang.loaiBaiGiang.name() == 'TRACNGHIEM'}"
                                        class="flex-grow-1 overflow-auto mt-30 text-center">

                                        <input type="hidden" id="taiKhoanId"
                                            th:value="${taiKhoanId}" />
                                        <input type="hidden"
                                            id="baiTracNghiemId"
                                            th:value="${baiTracNghiem.tracnghiemId}" />

                                        <p class="fw-bold">
                                            <i
                                                class="fas fa-clipboard-check me-2 text-primary"></i>
                                            B√†i ki·ªÉm tra s·ªë <span
                                                th:text="${thuTuBaiTracNghiem}"></span>
                                            - S·ªë c√¢u h·ªèi: <span
                                                th:text="${tongSoCauHoi}"></span>
                                        </p>
                                        <button id="batDauBtn" class="btn">
                                            <i
                                                class="fas fa-hourglass-start me-1"></i>
                                            B·∫Øt ƒë·∫ßu l√†m b√†i ki·ªÉm tra
                                        </button>

                                        <div id="noiDungBaiTracNghiem"
                                            style="display: none;" class="mt-3">
                                            <div id="cauHoiContainer">
                                                <div
                                                    th:if="${baiTracNghiem != null && baiTracNghiem.cauHoiList != null}">
                                                    <div
                                                        th:each="cauHoi, iterStat : ${baiTracNghiem.cauHoiList}"
                                                        class="cau-hoi"
                                                        th:attr="data-cauhoi-id=${cauHoi.cauHoiId}"
                                                        th:classappend="${iterStat.index != 0} ? 'd-none' : ''">

                                                        <p>
                                                            <i
                                                                class="fas fa-question-circle me-2 text-info"></i>
                                                            <strong
                                                                th:text="'C√¢u ' + (${iterStat.index + 1}) + ': ' + ${cauHoi.tenCauHoi}"></strong>
                                                        </p>

                                                        <ul
                                                            class="list-unstyled text-start ps-4">
                                                            <li
                                                                th:each="dapAn, stat : ${cauHoi.dapAnList}">
                                                                <label>
                                                                    <input
                                                                        type="radio"
                                                                        th:name="'cauHoi_' + ${cauHoi.cauHoiId}"
                                                                        th:value="${dapAn.dapanId}"
                                                                        th:attrappend="data-dung=${dapAn.dapAnDung} ? 'true' : 'false'">
                                                                    <strong
                                                                        th:text="${'ABCD'[stat.index]} + '.'"></strong>
                                                                    <span
                                                                        th:text="${dapAn.noiDungDapAn}">N·ªôi
                                                                        dung</span>
                                                                </label>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>

                                            <button id="btnCauTruoc"
                                                class="btn me-2 d-none">
                                                <i
                                                    class="fas fa-arrow-left me-1"></i>
                                                C√¢u tr∆∞·ªõc
                                            </button>

                                            <button id="btnTiepTuc" class="btn"
                                                disabled>C√¢u ti·∫øp theo</button>

                                            <div id="ketQuaContainer"
                                                class="mt-3 d-none">
                                                <h5 class="text-success">
                                                    üéâ B·∫°n ƒë√£ ho√†n th√†nh b√†i
                                                    tr·∫Øc nghi·ªám!
                                                </h5>
                                                <p><strong>B√†i tr·∫Øc
                                                        nghi·ªám:</strong> <span
                                                        th:text="${baiGiang.tenBaiGiang}">T√™n
                                                        b√†i
                                                        gi·∫£ng</span>
                                                </p>
                                                <div
                                                    class="d-flex justify-content-center gap-3">
                                                    <p class="mb-0">
                                                        <strong>K·∫øt
                                                            qu·∫£:</strong>
                                                        <span
                                                            id="diemSo">0</span>
                                                        ƒëi·ªÉm
                                                    </p> <strong>-</strong>
                                                    <p class="mb-0">
                                                        <strong>ƒê√∫ng:</strong>
                                                        <span
                                                            id="soDung">0</span>/<span
                                                            id="tongCau">0</span>
                                                        c√¢u
                                                    </p>
                                                </div>

                                                <div
                                                    class="d-flex justify-content-center gap-4 mt-2">
                                                    <p class="mb-0"><strong>B·∫Øt
                                                            ƒë·∫ßu:</strong> <span
                                                            id="thoiGianBatDau">--:--</span></p>
                                                    <p class="mb-0"><strong>Ho√†n
                                                            th√†nh:</strong>
                                                        <span
                                                            id="thoiGianHoanThanh">--:--</span></p>
                                                </div>

                                                <div
                                                    class="d-flex justify-content-center gap-3 mt-3">
                                                    <button id="btnLamLai"
                                                        class="btn btn-outline-secondary">
                                                        <i
                                                            class="fas fa-redo-alt me-1"></i>
                                                        L√†m l·∫°i
                                                    </button>
                                                    <button id="btnChiTiet"
                                                        class="btn btn-outline-info">
                                                        <i
                                                            class="fas fa-list-ul me-1"></i>
                                                        Xem k·∫øt qu·∫£ chi ti·∫øt
                                                    </button>
                                                </div>

                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div
                                th:if="${khoaHoc.trangThai.name() == 'PENDING_APPROVAL'}"
                                class="mt-4">
                                <div
                                    class="card shadow-sm rounded-3 p-4 border-0 bg-white">
                                    <h5
                                        class="mb-3 text-center text-primary fw-bold">Ph√™
                                        duy·ªát kh√≥a h·ªçc</h5>

                                    <div
                                        class="d-flex justify-content-center gap-3 flex-wrap">
                                        <!-- N√∫t duy·ªát -->
                                        <button type="button"
                                            class="btn btn-outline-success px-3 py-2 rounded-pill fw-semibold shadow-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#modalXacNhan-${khoaHoc.khoahocId}">
                                            <i class="fas fa-check me-2"></i>
                                            Duy·ªát
                                        </button>

                                        <!-- N√∫t t·ª´ ch·ªëi -->
                                        <button type="button"
                                            class="btn btnTuChoi btn-outline-danger px-3 py-2 rounded-pill fw-semibold shadow-sm"
                                            data-id="${khoaHoc.khoahocId}">
                                            <i class="fas fa-times me-2"></i>T·ª´
                                            ch·ªëi
                                        </button>

                                        <!-- N√∫t quay l·∫°i -->
                                        <a
                                            th:href="@{'/kiem-duyet-khoa-hoc/' + ${khoaHoc.khoahocId}}"
                                            class="btn btn-outline-secondary px-3 py-2 rounded-pill fw-semibold shadow-sm">
                                            <i
                                                class="fas fa-arrow-left me-2"></i>
                                            Quay l·∫°i
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="tuChoi-container mt-2"
                                id="tuChoi-${khoaHoc.khoahocId}"
                                style="display: none;">
                                <form method="post"
                                    th:action="@{'/xac-nhan-phe-duyet/tu-choi/' + ${khoaHoc.khoahocId}}">
                                    <label for="lyDo-${khoaHoc.khoahocId}"
                                        class="form-label fw-semibold">L√Ω do t·ª´
                                        ch·ªëi</label>
                                    <textarea id="lyDo-${khoaHoc.khoahocId}"
                                        name="lyDo"
                                        class="form-control tuChoi-textarea"
                                        rows="3"
                                        placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi..."
                                        required></textarea>
                                    <button type="submit"
                                        class="btn btn-danger tuChoi-btn mt-2">
                                        ‚ùå X√°c nh·∫≠n t·ª´ ch·ªëi
                                    </button>
                                </form>
                            </div>

                        </div>

                        <!-- C·ªôt danh s√°ch ch∆∞∆°ng v√† b√†i gi·∫£ng -->
                        <div class="col-lg-4">
                            <div class="card shadow-sm rounded-4 mb-4 border-0">
                                <div class="card-body" id="chuong-list">
                                    <div th:if="${#lists.isEmpty(chuongs)}">
                                        <p class="text-muted fst-italic">Ch∆∞a c√≥
                                            ch∆∞∆°ng n√†o cho kh√≥a h·ªçc n√†y.</p>
                                    </div>

                                    <div th:if="${!#lists.isEmpty(chuongs)}"
                                        class="accordion" id="accordionChuong">
                                        <div class="accordion-item mb-2"
                                            th:each="chuong, iterStat : ${chuongs}">
                                            <h2 class="accordion-header"
                                                th:attr="id='heading' + ${iterStat.index}">
                                                <button
                                                    class="accordion-button collapsed bg-light"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    th:attr="data-bs-target='#collapse' + ${iterStat.index}"
                                                    aria-expanded="false"
                                                    th:attrappend="aria-controls='collapse' + ${iterStat.index}">
                                                    <i
                                                        class="fas fa-layer-group me-2 text-warning"></i>
                                                    <strong
                                                        th:text="${chuong.tenchuong}">T√™n
                                                        ch∆∞∆°ng</strong>
                                                </button>
                                            </h2>
                                            <div
                                                th:attr="id='collapse' + ${iterStat.index}"
                                                class="accordion-collapse collapse"
                                                th:classappend="${chuong.chuongId == chuongDangMoId} ? ' show' : ''"
                                                th:attrappend="aria-labelledby='heading' + ${iterStat.index}"
                                                data-bs-parent="#accordionChuong">
                                                <div class="accordion-body">
                                                    <ul
                                                        class="list-group list-group-flush mb-0"
                                                        th:if="${chuong.baiGiangs != null && !#lists.isEmpty(chuong.baiGiangs)}">
                                                        <li
                                                            class="list-group-item ps-4"
                                                            th:each="baiGiang : ${chuong.baiGiangs}"
                                                            th:classappend="${baiGiang.baiGiangId == baiGiangDangHocId} ? 'active-bai-giang' : ''">

                                                            <a
                                                                th:href="@{'/kiem-duyet-khoa-hoc/khoa-hoc/noi-dung-bai-giang/' + ${baiGiang.baiGiangId}}"
                                                                class="bai-giang-link d-flex align-items-center">

                                                                <i
                                                                    th:class="${baiGiang.loaiBaiGiang.name() == 'VIDEO' ? 
                                                                        'fas fa-play-circle text-danger me-2' : 
                                                                        baiGiang.loaiBaiGiang.name() == 'TAILIEU' ? 
                                                                        'fas fa-file-alt text-success me-2' : 
                                                                        'fas fa-question-circle text-warning me-2'}"></i>
                                                                <span
                                                                    th:text="${baiGiang.tenBaiGiang}">T√™n
                                                                    b√†i
                                                                    gi·∫£ng</span>
                                                            </a>

                                                        </li>
                                                    </ul>
                                                    <p
                                                        th:if="${chuong.baiGiangs == null || #lists.isEmpty(chuong.baiGiangs)}"
                                                        class="text-muted fst-italic mt-2 ps-2">
                                                        <i
                                                            class="fas fa-exclamation-circle me-1"></i>
                                                        Ch∆∞a c√≥ b√†i gi·∫£ng n√†o
                                                        trong ch∆∞∆°ng n√†y.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script th:inline="javascript">
            let ketQuaId = null;

            function dinhDangNgayGio(date) {
                const pad = (n) => n.toString().padStart(2, '0');
                const gio = pad(date.getHours());
                const phut = pad(date.getMinutes());
                const ngay = pad(date.getDate());
                const thang = pad(date.getMonth() + 1);
                const nam = date.getFullYear();
                return `${gio}:${phut} - ${ngay}/${thang}/${nam}`;
            }
            document.addEventListener("DOMContentLoaded", () => {
                const btnBatDau = document.getElementById("batDauBtn");
                const noiDung = document.getElementById("noiDungBaiTracNghiem");
                const btnNext = document.getElementById("btnTiepTuc");
                const btnPrev = document.getElementById("btnCauTruoc");
                const ketQuaContainer = document.getElementById("ketQuaContainer");
                const cauHoiContainer = document.getElementById("cauHoiContainer");
                const cauHoiList = Array.from(document.querySelectorAll(".cau-hoi"));

                const btnLamLai = document.getElementById("btnLamLai");
                const btnChiTiet = document.getElementById("btnChiTiet");

                let idx = 0;
                let thoiGianBatDau = null;

                if (btnBatDau && noiDung) {
                    btnBatDau.addEventListener("click", () => {
                        btnBatDau.classList.add("d-none");
                        noiDung.style.display = "block";
                        thoiGianBatDau = new Date();
                    });
                }

                function isAllAnswered() {
                    return cauHoiList.every(cauHoi => {
                        const radio = cauHoi.querySelector("input[type='radio']");
                        const name = radio ? radio.name : null;
                        return name && document.querySelector(`input[name='${name}']:checked`);
                    });
                }

                function updateView() {
                    cauHoiList.forEach((c, i) => c.classList.toggle("d-none", i !== idx));
                    btnPrev.classList.toggle("d-none", idx === 0);

                    if (idx === cauHoiList.length - 1) {
                        btnNext.innerText = "Xem k·∫øt qu·∫£";
                        btnNext.disabled = !isAllAnswered();
                    } else {
                        btnNext.innerText = "C√¢u ti·∫øp theo";
                        btnNext.disabled = false;
                    }
                }

                if (btnLamLai) {
                    btnLamLai.addEventListener("click", () => {
                        // Reset bi·∫øn
                        idx = 0;
                        thoiGianBatDau = new Date(); // G√°n l·∫°i th·ªùi gian b·∫Øt ƒë·∫ßu m·ªõi

                        // B·ªè ch·ªçn t·∫•t c·∫£ ƒë√°p √°n
                        document.querySelectorAll("input[type='radio']:checked").forEach(radio => {
                            radio.checked = false;
                        });

                        // ·∫®n k·∫øt qu·∫£, hi·ªán l·∫°i n·ªôi dung l√†m b√†i
                        ketQuaContainer.classList.add("d-none");
                        cauHoiContainer.classList.remove("d-none");
                        btnNext.classList.remove("d-none");
                        btnPrev.classList.add("d-none"); // quay v·ªÅ c√¢u 0 th√¨ ·∫©n n√∫t "tr∆∞·ªõc"
                        btnNext.innerText = "C√¢u ti·∫øp theo";
                        btnNext.disabled = false;

                        // Reset hi·ªÉn th·ªã th·ªùi gian v√† ƒëi·ªÉm
                        document.getElementById("thoiGianBatDau").innerText = "--:--";
                        document.getElementById("thoiGianHoanThanh").innerText = "--:--";
                        document.getElementById("diemSo").innerText = "0";
                        document.getElementById("soDung").innerText = "0";
                        document.getElementById("tongCau").innerText = "0";

                        // C·∫≠p nh·∫≠t l·∫°i hi·ªÉn th·ªã c√¢u h·ªèi
                        updateView();

                        // Cu·ªôn l√™n ƒë·∫ßu ph·∫ßn n·ªôi dung
                        window.scrollTo({
                            top: 0,
                            behavior: "smooth"
                        });
                    });
                }


                if (btnNext && btnPrev && cauHoiList.length) {
                    btnNext.addEventListener("click", () => {
                        if (idx < cauHoiList.length - 1) {
                            idx++;
                            updateView();
                        } else {
                            let dung = 0;
                            cauHoiList.forEach(cauHoi => {
                                const dapAnDung = cauHoi.querySelector("input[type='radio'][data-dung='true']");
                                const daChon = cauHoi.querySelector("input[type='radio']:checked");
                                if (dapAnDung && daChon && dapAnDung.value === daChon.value) dung++;
                            });

                            const tongCau = cauHoiList.length;
                            const tongDiem = parseFloat(((dung / tongCau) * 10).toFixed(2));
                            const diemMoiCau = 10 / tongCau;
                            const thoiGianHoanThanh = new Date();

                            // document.getElementById("diemSo").innerText = dung;
                            // document.getElementById("soDung").innerText = dung;
                            // document.getElementById("tongCau").innerText = cauHoiList.length;

                            document.getElementById("diemSo").innerText = tongDiem;
                            document.getElementById("soDung").innerText = dung;
                            document.getElementById("tongCau").innerText = tongCau;

                            if (thoiGianBatDau) {
                                document.getElementById("thoiGianBatDau").innerText = dinhDangNgayGio(thoiGianBatDau);
                            }
                            document.getElementById("thoiGianHoanThanh").innerText = dinhDangNgayGio(thoiGianHoanThanh);

                            cauHoiContainer.classList.add("d-none");
                            btnNext.classList.add("d-none");
                            btnPrev.classList.add("d-none");
                            ketQuaContainer.classList.remove("d-none");
                            window.scrollTo({
                                top: 0,
                                behavior: "smooth"
                            });

                            const baiTracNghiemInput = document.getElementById("baiTracNghiemId");
                            const baiTracNghiemId = baiTracNghiemInput ? parseInt(baiTracNghiemInput.value) : null;

                            const taiKhoanInput = document.getElementById("taiKhoanId");
                            const taiKhoanId = taiKhoanInput ? parseInt(taiKhoanInput.value) : null;

                            const chiTietCauHoi = cauHoiList.map(cauHoi => {
                                const cauHoiId = parseInt(cauHoi.getAttribute("data-cauhoi-id"));


                                const daChon = cauHoi.querySelector("input[type='radio']:checked");
                                const dapAnChonId = daChon ? parseInt(daChon.value) : null;
                                const dapAnDung = daChon ? daChon.getAttribute("data-dung") === "true" : false;

                                return {
                                    cauHoiId: cauHoiId,
                                    dapAnId: dapAnChonId,
                                    dapAnChon: dapAnChonId,
                                    dungHaySai: dapAnDung,
                                    diem: dapAnDung ? parseFloat(diemMoiCau.toFixed(2)) : 0
                                };
                            }).filter(ct => ct.cauHoiId !== null && ct.dapAnId !== null);

                            // Log ra ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu g·ª≠i ƒëi
                            console.log({
                                baiTracNghiemId,
                                taiKhoanId,
                                soCauDung: dung,
                                tongDiem: tongDiem,
                                tongCauHoi: tongCau,
                                thoiGianBatDau: thoiGianBatDau.toISOString(),
                                thoiGianKetThuc: thoiGianHoanThanh.toISOString(),
                                chiTietList: chiTietCauHoi
                            });

                            fetch('/ket-qua/luu', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        baiTracNghiemId,
                                        taiKhoanId,
                                        soCauDung: dung,
                                        tongDiem: tongDiem,
                                        tongCauHoi: tongCau,
                                        thoiGianBatDau: thoiGianBatDau.toISOString(),
                                        thoiGianKetThuc: thoiGianHoanThanh.toISOString(),
                                        chiTietList: chiTietCauHoi
                                    })
                                })
                                .then(res => res.json())
                                .then(data => {
                                    console.log("‚úÖ ƒê√£ l∆∞u k·∫øt qu·∫£:", data);
                                    ketQuaId = data.ketQuaId || data;
                                })
                                .catch(err => {
                                    console.error("‚ùå L·ªói khi l∆∞u k·∫øt qu·∫£:", err);
                                });
                        }
                    });

                    btnPrev.addEventListener("click", () => {
                        if (idx > 0) {
                            idx--;
                            updateView();
                        }
                    });

                    document.querySelectorAll("input[type='radio']").forEach(input => {
                        input.addEventListener("change", () => {
                            if (idx === cauHoiList.length - 1) {
                                btnNext.disabled = !isAllAnswered();
                            }
                        });
                    });

                    updateView();
                }
            });
        </script>

            <style>
            .list-group-item {
                border: 1px solid #dee2e6;
                padding: 15px;
                background-color: #fff;
                transition: all 0.3s ease;
            }
            
            .list-group-item:hover {
                background-color: #f9f9f9;
                transform: scale(1.01);
            }
            
            .accordion-button {
                white-space: normal !important;
                /* Cho ph√©p xu·ªëng d√≤ng */
                word-break: break-word;
                /* Ng·∫Øt d√≤ng n·∫øu t·ª´ qu√° d√†i */
            }
        </style>

            <script>
            document.addEventListener("DOMContentLoaded", function() {
                const buttons = document.querySelectorAll('.btnTuChoi');

                buttons.forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        const khoaHocId = btn.getAttribute('data-id');
                        const formContainer = document.getElementById(`tuChoi-${khoaHocId}`);

                        if (formContainer) {
                            // Toggle hi·ªán/·∫©n form t·ª´ ch·ªëi
                            formContainer.style.display = formContainer.style.display === 'none' ? 'block' : 'none';
                        }
                    });
                });
            });
        </script>

            <!-- Modal x√°c nh·∫≠n -->
            <div class="modal fade" id="modalXacNhan-${khoaHoc.khoahocId}"
                tabindex="-1" aria-labelledby="xacNhanLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <form
                            th:action="@{'/xac-nhan-phe-duyet/phe-duyet/' + ${khoaHoc.khoahocId}}"
                            method="post">
                            <div class="modal-header">
                                <h5 class="modal-title" id="xacNhanLabel">X√°c
                                    nh·∫≠n ph√™ duy·ªát
                                </h5>
                                <button type="button" class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="ƒê√≥ng"></button>
                            </div>
                            <div class="modal-body">
                                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ph√™ duy·ªát kh√≥a h·ªçc "<b
                                    th:text="${khoaHoc.tenKhoaHoc}"></b>" kh√¥ng?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">H·ªßy</button>
                                <button type="submit"
                                    class="btn btn-success">X√°c
                                    nh·∫≠n
                                    duy·ªát</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </body>

</html>